# openpilot Windows 記錄檔查看器 - 使用手冊

[English](USER_GUIDE.md) | 中文版

本手冊將幫助您開始使用 openpilot Windows 記錄檔查看器，並充分利用其功能。

**訊號定義**：使用 [FrogPilot](https://github.com/FrogAi/FrogPilot) 的訊號定義（相容 openpilot 0.9.7）

## 目錄

1. [安裝](#安裝)
2. [從 C3/C3X 取得記錄檔](#從-c3c3x-取得記錄檔)
3. [匯入資料](#匯入資料)
4. [介面導覽](#介面導覽)
5. [分析資料](#分析資料)
6. [影片播放](#影片播放)
7. [匯出資料](#匯出資料)
8. [鍵盤快捷鍵](#鍵盤快捷鍵)
9. [技巧與訣竅](#技巧與訣竅)

---

## 安裝

### 一般使用者（推薦）

1. 從 `release/v1.0/` 資料夾下載發行套件
2. 解壓縮到您偏好的位置（例如 `C:\openpilot-viewer\`）
3. 完成！無需安裝 Python。

### 開發者

1. 確保已安裝 Python 3.10+
2. 複製儲存庫
3. 建立虛擬環境：`python -m venv venv`
4. 啟動：`venv\Scripts\activate`
5. 安裝依賴：`pip install -r requirements.txt`
6. 執行：`python main.py`

---

## 從 C3/C3X 取得記錄檔

有兩種主要方法可以將記錄檔從您的 comma 設備傳輸到 Windows PC：

### 方法 1：SSH/SCP（推薦）

⚠️ **重要**：現代 C3/C3X 設備需要 SSH 金鑰認證（無密碼登入）。

**需求：**
- SSH 客戶端（Windows 10+ 內建，或使用 PuTTY）
- C3/C3X 和 PC 在同一網路
- **已配置 SSH 金鑰**（請搜尋「comma 3 SSH key 設定」或「comma 3X SSH 存取」）

**步驟：**

1. **設定 SSH 存取**（僅首次）
   - 請自行搜尋：「comma 3 SSH key 設定」或「comma 3X SSH 存取」
   - 您需要在 comma 設備上配置 GitHub SSH 金鑰
   - 詳細步驟請參考 comma.ai 文件或社群指南

2. **找到設備的 IP 位址**
   - 在 C3/C3X 上，前往 設定 → 網路
   - 記下 IP 位址（例如 `192.168.1.100`）

3. **透過 SSH 連接**
   ```bash
   # SSH 金鑰配置完成後
   ssh comma@192.168.1.100
   ```

4. **瀏覽到記錄檔目錄**
   ```bash
   cd /data/media/0/realdata/
   ls -lt  # 按修改時間列出記錄檔
   ```

5. **複製記錄檔到 Windows**

   從 Windows 命令提示字元或 PowerShell：
   ```bash
   # 複製整個 segment 資料夾
   scp -r comma@192.168.1.100:/data/media/0/realdata/2024-01-01--12-00-00 C:\logs\

   # 或複製特定檔案
   scp comma@192.168.1.100:/data/media/0/realdata/2024-01-01--12-00-00/0/rlog C:\logs\
   ```

### 方法 2：FTP 客戶端（初學者較容易）

**推薦工具：**
- WinSCP（免費，Windows）
- FileZilla（免費，跨平台）

⚠️ **重要**：您需要先配置 SSH 金鑰認證（請參閱方法 1，步驟 1）。

**使用 WinSCP 的步驟：**

1. 下載並安裝 [WinSCP](https://winscp.net/)
2. 啟動 WinSCP 並建立新連線：
   - **協定**：SCP 或 SFTP
   - **主機**：您的 C3/C3X IP（例如 `192.168.1.100`）
   - **使用者名稱**：`comma`
   - **認證**：配置 SSH 私鑰（必要！）
3. 點擊「登入」
4. 瀏覽到 `/data/media/0/realdata/`
5. 拖放資料夾到您的 Windows 位置

---

## 匯入資料

### 步驟 1：匯入訊號定義（首次及更新後）

在匯入任何記錄檔之前，您需要匯入訊號定義：

1. 點擊 **工具 → 匯入訊號定義**
2. 對話框顯示將要匯入的內容：
   - 來自 `log.capnp` 的 Cereal 訊號（FrogPilot 定義檔，相容 openpilot 0.9.7）- 300-500 個訊號
   - 來自 `data/dbc/` 資料夾的 DBC 檔案的 CAN 訊號
3. 點擊 **開始匯入**
4. 等待完成（通常 30-60 秒）

**必要檔案**：
- `log.capnp`（主要 schema 檔案 - 來自 FrogPilot）
- `car.capnp`、`legacy.capnp`、`custom.capnp`、`maptile.capnp`（依賴檔案 - 必須與 log.capnp 在同一目錄）
- `data/dbc/` 資料夾中的 DBC 檔案

注意：匯入時只需選擇 `log.capnp`，其他 4 個依賴檔案會自動從相同目錄載入。

⚠️ **何時需要重新匯入**：
- **首次**使用應用程式
- **更新訊號定義檔後**（log.capnp 或 DBC 檔案）
- **使用不同 openpilot/FrogPilot 版本的記錄檔時**

### 步驟 2：匯入 Segment

現在您可以匯入記錄檔資料：

1. 點擊 **工具 → 匯入 Segment**
2. 在匯入對話框中：
   - **Route 名稱**：選填，例如「高速公路測試駕駛」
   - **rlog 路徑**：瀏覽到您的 rlog 檔案（例如 `C:\logs\2024-01-01--12-00-00\0\rlog`）
   - **DBC 檔案**：選擇要用於 CAN 解析的 DBC 檔案（或保留預設）
3. 點擊 **開始匯入**

⚠️ **注意**：僅支援未壓縮的 `.rlog` 檔案。如果您有 `.bz2` 壓縮檔，請先解壓縮：
```bash
bzip2 -d rlog.bz2
```
4. 在記錄視窗中監控進度
5. 完成後，segment 會出現在主視窗中

**匯入時間**：取決於記錄檔大小，通常 1 分鐘的 segment 需要 1-5 分鐘。

---

## 介面導覽

### 主視窗佈局

```
┌─────────────────────────────────────────────────────────┐
│ 選單列                                                  │
├──────────────┬──────────────────────────────────────────┤
│              │                                          │
│  Segment     │                                          │
│  列表        │        影片播放器                         │
│  (左側)      │        (右上)                            │
│              │                                          │
├──────────────┼──────────────────────────────────────────┤
│              │                                          │
│  訊號        │        圖表區域                          │
│  選擇器      │        (右下)                            │
│  (左側)      │                                          │
│              │                                          │
└──────────────┴──────────────────────────────────────────┘
```

### Segment 列表（左側面板）

- 顯示所有匯入的 segment
- **雙擊** segment 以載入
- 右鍵選單：
  - 刪除 segment
  - 匯出資料
  - 檢視 segment 資訊

### 訊號選擇器（左側面板，底部）

- **搜尋框**：輸入以搜尋訊號（支援中英文）
- **核取方塊**：選擇/取消選擇要繪製的訊號
- **顏色指示器**：顯示圖表中使用的顏色
- **訊號類別**：
  - 📡 Cereal 訊號（來自 schema）
  - 🚗 CAN 訊號（來自 DBC）

### 影片播放器（右上）

- 顯示攝影機畫面（fcamera、ecamera、dcamera）
- 時間軸與圖表同步
- 控制項：播放、暫停、跳轉、逐影格

### 圖表區域（右下）

- 多訊號繪圖
- **X 軸**：時間（秒）
- **Y 軸**：訊號值
- **滑鼠互動**：
  - **滾輪**：放大/縮小
  - **點擊並拖曳**：平移
  - **右鍵**：重設視圖
  - **懸停**：顯示訊號值

---

## 分析資料

### 搜尋訊號

1. 使用訊號選擇器中的 **搜尋框**
2. 輸入關鍵字：
   - 英文：`speed`、`steering`、`acceleration`
   - 中文：`速度`、`轉向`、`加速度`
3. 支援模糊搜尋：`spd` 符合 `vEgo`（車速）

### 繪製訊號

1. **勾選** 訊號名稱旁的方塊以繪製
2. 訊號會以不同顏色出現在圖表中
3. **取消勾選** 以從圖表中移除

### 理解訊號類別

- **carState.vEgo**：車速（cereal 訊號）
- **steeringAngleDeg**：轉向角度（來自 DBC 的 CAN 訊號）
- **carControl.actuators**：控制輸出（cereal 訊號）

### 比較訊號

- 同時繪製多個訊號
- 不同訊號可能有不同的比例 - 這是正常的
- 使用圖表圖例按顏色識別訊號

### 時間導覽

- **點擊圖表**：影片跳至該時間戳
- **拖曳時間軸**：同步瀏覽影片和資料
- **鍵盤快捷鍵**：參見 [鍵盤快捷鍵](#鍵盤快捷鍵)

---

## 影片播放

### 選擇攝影機

1. 前往 **檢視 → 攝影機**
2. 選擇：
   - **fcamera**（前鏡頭，預設）
   - **ecamera**（廣角鏡頭）
   - **dcamera**（駕駛員鏡頭）

### 播放控制

- **空白鍵**：播放/暫停
- **左/右箭頭**：上一影格/下一影格
- **上/下箭頭**：跳轉 ±5 秒
- **點擊時間軸**：跳至特定時間

### 同步檢視

- 影片時間軸與圖表 X 軸連結
- 當您點擊圖表中的資料點時，影片跳至該影格
- 當您瀏覽影片時，圖表中的垂直線顯示當前時間

---

## 匯出資料

### 匯出為 CSV

1. 在 Segment 列表中右鍵點擊 segment
2. 選擇 **匯出為 CSV**
3. 選擇位置和檔名
4. CSV 包含：
   - 時間戳
   - 所有可用的訊號值
   - 每個時間樣本一行

### 匯出為 Parquet

1. 在 Segment 列表中右鍵點擊 segment
2. 選擇 **匯出為 Parquet**
3. 選擇位置和檔名
4. Parquet 格式：
   - 檔案大小比 CSV 小
   - 保留資料類型
   - 在 pandas/Python 中載入更快

### 使用匯出的資料

**Python 範例：**

```python
import pandas as pd

# 載入 CSV
df = pd.read_csv('segment_export.csv')

# 載入 Parquet
df = pd.read_parquet('segment_export.parquet')

# 分析
print(df['carState.vEgo'].describe())
print(df['steeringAngleDeg'].max())
```

---

## 鍵盤快捷鍵

| 按鍵 | 動作 |
|-----|------|
| **空白鍵** | 播放/暫停影片 |
| **左箭頭** | 上一影格 |
| **右箭頭** | 下一影格 |
| **上箭頭** | 跳轉 +5 秒 |
| **下箭頭** | 跳轉 -5 秒 |
| **Ctrl+O** | 開啟匯入 Segment 對話框 |
| **Ctrl+S** | 儲存/匯出目前 segment |
| **Ctrl+F** | 聚焦搜尋框 |
| **Ctrl+W** | 關閉目前 segment |
| **Ctrl+Q** | 結束應用程式 |
| **F11** | 切換全螢幕 |

---

## 技巧與訣竅

### 1. 更快的記錄檔傳輸

- 使用 **USB 線** 連接到 C3/C3X 以獲得更快的傳輸（需要設定 SSH over USB）
- 傳輸前壓縮記錄檔：`tar czf logs.tar.gz 2024-01-01--12-00-00/`

### 2. 組織記錄檔

建立資料夾結構：
```
C:\openpilot-logs\
├── 2024-01\
│   ├── 2024-01-01--12-00-00\
│   └── 2024-01-02--08-30-00\
└── 2024-02\
    └── 2024-02-05--15-45-00\
```

### 3. 自訂訊號翻譯

編輯 `data/translations/signals_zh_TW.json` 以新增您自己的翻譯：

```json
{
  "carState.vEgo": "車速",
  "carState.aEgo": "加速度",
  "myCustomSignal": "我的自訂訊號"
}
```

重新啟動應用程式以查看變更。

### 4. 新增自訂 DBC 檔案

1. 將您的 `.dbc` 檔案放在 `data/dbc/` 資料夾中
2. 重新啟動應用程式
3. 前往 **工具 → 匯入訊號定義**
4. 您的 DBC 訊號將被匯入

### 5. 效能最佳化

- 關閉未使用的 segment 以釋放記憶體
- 限制同時繪製的訊號數量（建議最多 10 個）
- 對大型資料集使用 Parquet 匯出

### 6. 疑難排解匯入錯誤

如果匯入失敗：
1. 檢查應用程式目錄中的 `oplog_viewer.log`
2. 驗證 rlog 檔案沒有損壞（必須是未壓縮的 `.rlog` 格式）
3. 如果您有 `.bz2` 檔案，請先解壓縮：`bzip2 -d rlog.bz2`
4. 確保 DBC 檔案有效
5. 先嘗試匯入較小的 segment

### 7. 離線工作

- 不需要網路連接！
- 所有處理都是本地的
- 資料庫儲存在 `oplog.db`（SQLite）

### 8. 備份您的資料庫

- 將 `oplog.db` 複製到備份位置
- 包含所有匯入的 segment 和訊號定義
- 透過替換檔案來還原

---

## 進階功能

### 資料庫管理

- **檢視 → 訊號資料庫管理器**：瀏覽所有訊號定義
- **工具 → 重設資料庫**：清除所有資料（請謹慎使用！）

### Route 管理

- **工具 → Route 管理器**：按 route 組織 segment
- 將相關的 segment 分組在一起
- 新增註解和詮釋資料

### 多語言支援

- **檢視 → 語言**：在 English 和繁體中文之間切換
- 訊號名稱會自動翻譯（如有可用）

---

## 取得協助

- **說明 → 使用手冊**：本文件
- **說明 → 鍵盤快捷鍵**：快速參考
- **說明 → 關於**：版本和授權資訊

---

## 回饋與貢獻

發現錯誤或有功能請求？請在 GitHub 上開啟 issue！

祝分析愉快！🚗📊
